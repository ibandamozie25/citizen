
{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">

  <h4 class="text-primary">Transport Hub</h4>
  <div class="mt-3">
    <a class="btn btn-primary" href="{{ url_for('start_payment') }}"> ← Back to Start Payment</a>


  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show">
          {{ message }}
          <button class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <div class="small text-muted mb-3">
    Term: <strong>{{ active_term }}</strong> &nbsp; Year: <strong>{{ active_year }}</strong>
  </div>

  <div class="row g-3">
    <!-- Manage routes + CSV -->
    <div class="col-lg-5">
      <form method="post" class="border rounded p-3 shadow-sm">
        <h6 class="mb-3">Route (Add/Update)</h6>
        <input type="hidden" name="action" value="add_route">
        <div class="mb-2">
          <label class="form-label">Route name</label>
          <input name="route_name" class="form-control" placeholder="e.g., City Route">
        </div>
        <div class="mb-2">
          <label class="form-label">Fare per term (UGX)</label>
          <input type="number" step="0.01" name="fare_per_term" class="form-control" placeholder="50000">
        </div>
        <button class="btn btn-primary">Save Route</button>
      </form>

      <div class="border rounded p-3 mt-3 shadow-sm">
        <h6 class="mb-2">Download CSV Template</h6>
        <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('transport_template_download') }}">Download template</a>
        <form method="post" enctype="multipart/form-data" class="mt-3">
          <input type="hidden" name="action" value="upload_csv">
          <div class="mb-2">
            <label class="form-label">Upload CSV/XLSX</label>
            <input type="file" name="file" class="form-control" accept=".csv,.xlsx">
          </div>
          <button class="btn btn-outline-primary btn-sm">Process File</button>
        </form>
      </div>

      <div class="border rounded p-3 mt-3 shadow-sm">
        <h6 class="mb-2">Delete Route</h6>
        <form method="post" onsubmit="return confirm('Delete this route?');">
          <input type="hidden" name="action" value="delete_route">
          <div class="input-group">
            <select name="route_id" class="form-select">
              <option value="">-- Choose route --</option>
              {% for r in routes %}
                <option value="{{ r.id }}">{{ r.name }}</option>
              {% endfor %}
            </select>
            <button class="btn btn-outline-danger">Delete</button>
			<a href="{{ url_for('register_student') }}" class="btn btn-primary">← Back </a>
          </div>
        </form>
      </div>
    </div>

    <!-- Subscribe / Unsubscribe / Pay -->
    <div class="col-lg-7">

      <!-- Subscribe / Unsubscribe -->
      <div class="border rounded p-3 shadow-sm mb-3">
        <h6 class="mb-3">Subscribe / Unsubscribe</h6>
        <form method="post" class="row g-2" id="form-sub">
          <input type="hidden" name="action" value="subscribe">
          <div class="col-md-4">
            <label class="form-label">Student Number</label>
            <div class="input-group">
              <input id="sn-sub" name="student_number" class="form-control" placeholder="STU-0001">
              <a id="link-sub" class="btn btn-outline-secondary" target="_blank" title="Open in Students list">Open</a>
            </div>
            <div class="small mt-1">
              <span id="name-sub" class="fw-semibold"></span>
              <span id="class-sub" class="text-muted"></span>
            </div>
          </div>
          <div class="col-md-4">
            <label class="form-label">Route</label>
            <select id="route-sub" name="route_id" class="form-select">
              <option value="">-- Choose route --</option>
              {% for r in routes %}
                <option value="{{ r.id }}">{{ r.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">Term</label>
            <select name="term" class="form-select">
              {% for t in TERMS %}
                <option value="{{ t }}" {{ 'selected' if t==active_term else '' }}>{{ t }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">Year</label>
            <input type="number" name="year" value="{{ active_year }}" class="form-control">
          </div>
          <div class="col-12 d-flex gap-2">
            <button class="btn btn-success">Subscribe</button>
            <button class="btn btn-outline-warning"
                    formaction="{{ url_for('transport_hub') }}" formmethod="post"
                    name="action" value="unsubscribe">
              Unsubscribe
            </button>
          </div>
        </form>
      </div>

      <!-- Pay -->
      <div class="border rounded p-3 shadow-sm">
        <h6 class="mb-3">Record Transport Payment (to Other Income)</h6>
        <form method="post" class="row g-2" id="form-pay">
          <input type="hidden" name="action" value="pay">
          <div class="col-md-4">
            <label class="form-label">Student Number</label>
            <div class="input-group">
              <input id="sn-pay" name="student_number" class="form-control" placeholder="STU-0001">
              <a id="link-pay" class="btn btn-outline-secondary" target="_blank" title="Open in Students list">Open</a>
            </div>
            <div class="small mt-1">
              <span id="name-pay" class="fw-semibold"></span>
              <span id="class-pay" class="text-muted"></span>
            </div>
          </div>
          <div class="col-md-3">
            <label class="form-label">Amount</label>
            <input type="number" step="0.01" name="amount" class="form-control" placeholder="50000">
          </div>
          <div class="col-md-3">
            <label class="form-label">Method</label>
            <select name="method" class="form-select">
              <option>Cash</option>
              <option>Mobile</option>
              <option>Bank</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">Term</label>
            <select name="term" class="form-select">
              {% for t in TERMS %}
                <option value="{{ t }}" {{ 'selected' if t==active_term else '' }}>{{ t }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-12 mt-2">
            <button class="btn btn-primary">Save Payment</button>
          </div>
        </form>
        <div class="small text-muted mt-2">
          Saved rows will show in <em>Other Income</em> with description “Transport” and a source like
          <code>Transport (SN: STU-0001) - City Route</code>.
        </div>
      </div>
    </div>
  </div>

  <!-- Filter by route -->
  <div class="border rounded p-3 shadow-sm mt-4">
    <form class="row g-2" method="get">
      <div class="col-md-6">
        <label class="form-label">Filter by Route</label>
        <select name="route_id" class="form-select" onchange="this.form.submit()">
          <option value="">All routes</option>
          {% for r in routes %}
            <option value="{{ r.id }}" {{ 'selected' if (route_filter|int)==r.id else '' }}>{{ r.name }}</option>
          {% endfor %}
        </select>
      </div>
    </form>
  </div>

  <!-- Subscribers + Balances -->
  <div class="table-responsive mt-3">
    <table class="table table-striped table-bordered align-middle">
      <thead class="table-primary">
        <tr>
          <th>#</th>
          <th>Student</th>
          <th>Class/Stream</th>
          <th>Route</th>
          <th>Fare (Term)</th>
          <th>Paid ({{ active_term }} {{ active_year }})</th>
          <th>Balance</th>
        </tr>
      </thead>
      <tbody>
        {% for b in balances %}
        <tr>
          <td>{{ loop.index }}</td>
          <td>{{ b.student_number }} — {{ b.full_name }}</td>
          <td>{{ b.class_name }} {{ b.stream }}</td>
          <td>{{ b.route_name }}</td>
          <td>{{ "{:,.0f}".format(b.fare_per_term or 0) }}</td>
          <td>{{ "{:,.0f}".format(b.paid or 0) }}</td>
          <td class="{{ 'text-danger' if (b.balance or 0)>0 else 'text-success' }}">
            {{ "{:,.0f}".format(b.balance or 0) }}
          </td>
        </tr>
        {% else %}
        <tr><td colspan="7" class="text-center">No active subscribers.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>

<!-- ====== Lightweight JS to auto-populate name/route and open link ====== -->
<script>
(function(){
  function updateLink(elInput, elLink){
    const sn = elInput.value.trim();
    // If your students list uses a different URL or param, change here:
    elLink.href = '/students?q=' + encodeURIComponent(sn);
    elLink.classList.toggle('disabled', !sn);
  }

  async function lookup(sn){
    if(!sn) return null;
    try{
      const r = await fetch('/api/student/by_number?sn=' + encodeURIComponent(sn));
      if(!r.ok) return null;
      const j = await r.json();
      if(j && j.success) return j.data;
    }catch(e){}
    return null;
  }

  // --- Subscribe form wiring ---
  const snSub = document.getElementById('sn-sub');
  const linkSub = document.getElementById('link-sub');
  const nameSub = document.getElementById('name-sub');
  const classSub = document.getElementById('class-sub');
  const routeSub = document.getElementById('route-sub');

  function clearSub(){
    nameSub.textContent = '';
    classSub.textContent = '';
  }

  async function hydrateSub(){
    updateLink(snSub, linkSub);
    const data = await lookup(snSub.value.trim());
    if(!data){ clearSub(); return; }
    nameSub.textContent = data.full_name;
    classSub.textContent = `(${data.class_name || ''} ${data.stream || ''})`.trim();
    // If the student is already subscribed, pre-select that route
    if(data.route_id){
      for (const opt of routeSub.options){
        if(String(opt.value) === String(data.route_id)){ opt.selected = true; break; }
      }
    }
  }

  snSub.addEventListener('change', hydrateSub);
  snSub.addEventListener('keyup', () => updateLink(snSub, linkSub));
  updateLink(snSub, linkSub); // initial

  // --- Pay form wiring ---
  const snPay = document.getElementById('sn-pay');
  const linkPay = document.getElementById('link-pay');
  const namePay = document.getElementById('name-pay');
  const classPay = document.getElementById('class-pay');

  function clearPay(){ namePay.textContent=''; classPay.textContent=''; }

  async function hydratePay(){
    updateLink(snPay, linkPay);
    const data = await lookup(snPay.value.trim());
    if(!data){ clearPay(); return; }
    namePay.textContent = data.full_name;
    classPay.textContent = `(${data.class_name || ''} ${data.stream || ''})`.trim();
  }

  snPay.addEventListener('change', hydratePay);
  snPay.addEventListener('keyup', () => updateLink(snPay, linkPay));
  updateLink(snPay, linkPay); // initial
})();
</script>
{% endblock %}
