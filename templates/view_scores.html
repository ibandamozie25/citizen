
{% extends 'base.html' %}
{% block content %}

<div class="container mt-4">
  <h3 class="text-primary text-center mb-4">View Scores (Grouped by Subject)</h3>

  <form method="GET" class="row g-3 mb-4">
    <div class="col-md-2">
      <label>Class</label>
      <select name="class_name" class="form-control" required>
        <option value="">--Select--</option>
        {% for c in ['S1', 'S2', 'S3', 'S4', 'S5', 'S6'] %}
          <option value="{{ c }}" {% if class_name == c %}selected{% endif %}>{{ c }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <label>Stream</label>
      <select name="stream" class="form-control" required>
        <option value="">--Select--</option>
        {% for s in ['East', 'West', 'North', 'South'] %}
          <option value="{{ s }}" {% if stream == s %}selected{% endif %}>{{ s }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <label>Year</label>
      <select name="year" class="form-control" required>
        {% for y in available_years %}
          <option value="{{ y }}" {% if year == y %}selected{% endif %}>{{ y }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <label>Term</label>
      <select name="term" class="form-control" required>
        {% for t in ['1', '2', '3'] %}
          <option value="{{ t }}" {% if term == t %}selected{% endif %}>Term {{ t }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <label>Subject</label>
      <select name="subject_id" class="form-control" required>
        {% for subj in subjects %}
          <option value="{{ subj.id }}" {% if subject_id == subj.id|string %}selected{% endif %}>{{ subj.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2 d-flex align-items-end">
      <button type="submit" class="btn btn-primary">Search</button>
    </div>
  </form>

  {% if results_by_student %}
    <div class="table-responsive">
      <table class="table table-bordered text-center">
        <thead class="table-dark">
          <tr>
            <th>#</th>
            <th>Student No.</th>
            <th>Full Name</th>
            <th>Subject</th>
            <th>Paper</th>
            <th>BOT</th>
            <th>MID</th>
            <th>EOT</th>
            <th>Avg (Paper)</th>
          </tr>
        </thead>
        <tbody>
          {% for student in results_by_student %}
            {% set row_index = loop.index %}
            {% for paper in student.papers %}
              <tr>
                <td>{{ row_index }}</td>
                <td>{{ student.student_number }}</td>
                <td>{{ student.full_name }}</td>
                <td>{{ student.subject }}</td>
                <td>{{ paper.subject_part or '-' }}</td>
                <td>{{ paper.bot_mark or '' }}</td>
                <td>{{ paper.midterm_mark or '' }}</td>
                <td>{{ paper.eot_mark or '' }}</td>
                <td>{{ '{:.1f}'.format(paper.avg_mark) if paper.avg_mark is defined else '' }}</td>
              </tr>
            {% endfor %}
            <tr class="table-info">
              <td colspan="8" class="text-end"><strong>Overall Subject Avg:</strong></td>
              <td><strong>{{ '{:.1f}'.format(student.total_avg) if student.total_avg is defined else '0.0' }}</strong></td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="alert alert-warning text-center">No records found for selected filters.</div>
  {% endif %}
</div>

{% endblock %}
