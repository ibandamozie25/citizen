
{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">

  <!-- Greeting -->
  <h2 class="text-center text-primary mb-1">
    Welcome {{ username or 'User' }}{% if user_id %} (ID: {{ user_id }}){% endif %}
  </h2>
  <p class="text-center text-muted mb-4">
    Active Session: <strong>{{ active_term or 'Term 1' }} {{ active_year or '' }}</strong>
  </p>

  <!-- Flash messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-3">
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- Menu Sections as Collapsible Rows -->
  <div class="accordion" id="dashboardAccordion">

    <!-- Student Management -->
    <div class="accordion-item mb-3">
      <h2 class="accordion-header" id="headingStudents">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                data-bs-target="#collapseStudents" aria-expanded="false" aria-controls="collapseStudents"
                style="color:#1D4ED8; font-weight:600;">
          Student Management
        </button>
      </h2>
      <div id="collapseStudents" class="accordion-collapse collapse" aria-labelledby="headingStudents" data-bs-parent="#dashboardAccordion">
        <div class="accordion-body bg-light">
          <div class="d-grid gap-2">
            <a href="{{ url_for('register_student') }}" class="btn btn-outline-primary btn-sm"
               data-roles="admin,headteacher,clerk">Student Hub</a>

            <a href="{{ url_for('marks_hub') }}" class="btn btn-outline-primary btn-sm"
               data-roles="admin,headteacher,dos,teacher">Marks(Exams and other assessments)</a>

            <a href="{{ url_for('reports_hub') }}" class="btn btn-outline-primary btn-sm"
               data-roles="admin,headteacher,dos">Reports (Process &amp; Print)</a>

            <a href="{{ url_for('promotions_hub') }}" class="btn btn-outline-primary btn-sm"
               data-roles="admin,headteacher,bursar">Promotion process</a>

            <!-- <a href="{{ url_for('opening_balance_bulk') }}" class="btn btn-outline-primary btn-sm"
                 data-roles="admin,bursar">b/f</a> -->
          </div>
        </div>
      </div>
    </div>

    <!-- Administration -->
    <div class="accordion-item mb-3">
      <h2 class="accordion-header" id="headingAdmin">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                data-bs-target="#collapseAdmin" aria-expanded="false" aria-controls="collapseAdmin"
                style="color:#16A34A; font-weight:600;">
          Administration
        </button>
      </h2>
      <div id="collapseAdmin" class="accordion-collapse collapse" aria-labelledby="headingAdmin" data-bs-parent="#dashboardAccordion">
        <div class="accordion-body bg-light">
          <div class="d-grid gap-2">
            <a href="{{ url_for('manage_subjects') }}" class="btn btn-outline-success btn-sm"
               data-roles="admin,headteacher,dos">Manage(Subjects|Grading|Tr-Head-Comments)</a>

            <a href="{{ url_for('admin_class_fees') }}" class="btn btn-outline-success btn-sm"
               data-roles="admin,bursar,headteacher">Manage(Class Fees|Bursaries|Requirements)</a>

            <a href="{{ url_for('asset_register') }}" class="btn btn-outline-success btn-sm"
               data-roles="admin,bursar,headteacher">Asset Register</a>

            <a href="{{ url_for('academic_years') }}" class="btn btn-outline-success btn-sm"
               data-roles="admin,headteacher">Academic Year Setting</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Users -->
    <div class="accordion-item mb-3">
      <h2 class="accordion-header" id="headingUsers">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                data-bs-target="#collapseUsers" aria-expanded="false" aria-controls="collapseUsers"
                style="color:#0EA5E9; font-weight:600;">
          Users
        </button>
      </h2>
      <div id="collapseUsers" class="accordion-collapse collapse" aria-labelledby="headingUsers" data-bs-parent="#dashboardAccordion">
        <div class="accordion-body bg-light">
          <div class="d-grid gap-2">
            <a href="{{ url_for('employees_hub') }}" class="btn btn-outline-info btn-sm"
               data-roles="admin,bursar,headteacher">Staff (All Employees)</a>

            <a href="{{ url_for('manage_users') }}" class="btn btn-outline-info btn-sm"
               data-roles="admin">User Rights</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Finance & Reports -->
    <div class="accordion-item mb-3">
      <h2 class="accordion-header" id="headingReports">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                data-bs-target="#collapseReports" aria-expanded="false" aria-controls="collapseReports"
                style="color:#FACC15; font-weight:600;">
          Finance &amp; Reports
        </button>
      </h2>
      <div id="collapseReports" class="accordion-collapse collapse" aria-labelledby="headingReports" data-bs-parent="#dashboardAccordion">
        <div class="accordion-body bg-light">
          <div class="d-grid gap-2">
            <a href="{{ url_for('finance_hub') }}" class="btn btn-outline-warning btn-sm"
               data-roles="admin,bursar,director,headteacher">Finance Hub</a>

            <a href="{{ url_for('payroll_export') }}" class="btn btn-outline-warning btn-sm"
               data-roles="admin,director,bursar">Payroll Report</a>

            <a href="{{ url_for('fees_report') }}" class="btn btn-outline-warning btn-sm"
               data-roles="admin,bursar,headteacher">FP report</a>

            <a href="{{ url_for('students_finance_report') }}" class="btn btn-outline-warning btn-sm"
               data-roles="admin,bursar,headteacher">Students Finance Report</a>

            <a href="{{ url_for('performance_summary') }}" class="btn btn-outline-warning btn-sm"
               data-roles="admin,headteacher,dos,teacher,bursar">Perfomance Summary</a>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Statistics Bar (admin only, as you had) -->
  {% if session.role in ["admin","director","headteacher"] %}
  <div class="row mt-4 mb-4">
    <div class="col-12">
      <div class="d-flex flex-wrap justify-content-around align-items-center gap-3 p-3 rounded" style="background-color:#1D4ED8;">
        <div class="text-center text-white">
          <strong>Total Students:</strong> {{ stats.total_students or 0 }}
        </div>
        <div class="text-center text-white">
          <strong>{{ active_term }} Net Income:</strong> UGX {{ "{:,.0f}".format((stats.term_net_income or 0)) }}
        </div>
        <div class="text-center text-white">
          <strong>Cumulative Income:</strong> UGX {{ "{:,.0f}".format((stats.cumulative_net_income or 0)) }}
        </div>
        <div class="text-center text-white">
          <strong>Total Expenses:</strong> UGX {{ "{:,.0f}".format((stats.total_expenses or 0)) }}
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<!-- Role-based fading/disable -->
<style>
  .role-disabled {
    opacity: 0.45 !important;
    pointer-events: none !important;
    cursor: not-allowed !important;
  }
</style>
<script>
  // expose current role from session for the client-side guard
  window.CURRENT_ROLE = "{{ (session.role or '')|lower|e }}";

  function isAllowedForCurrentRole(requiredRolesAttr) {
    if (!requiredRolesAttr) return true; // no restriction
    const required = requiredRolesAttr
      .split(",")
      .map(r => r.trim().toLowerCase())
      .filter(Boolean);
    return required.includes((window.CURRENT_ROLE || "").toLowerCase());
  }

  function applyRoleGuards() {
    document.querySelectorAll("[data-roles]").forEach(el => {
      const needed = el.getAttribute("data-roles");
      if (!isAllowedForCurrentRole(needed)) {
        el.classList.add("role-disabled");
        el.setAttribute("aria-disabled", "true");
        if (!el.getAttribute("title")) {
          el.setAttribute("title", "Not allowed for your role");
        }
      }
    });
  }

  document.addEventListener("DOMContentLoaded", applyRoleGuards);
</script>
{% endblock %}
