
{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
  <h4 class="text-primary mb-3">Bulk Import â€“ Opening Balances</h4>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show">
          {{ message }}
          <button type="button" class="btn btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <div class="mb-3">
    <a href="{{ url_for('opening_balance_template_csv') }}" class="btn btn-outline-secondary btn-sm">Download CSV template</a>
    <a href="{{ url_for('opening_balance_template_xlsx') }}" class="btn btn-outline-secondary btn-sm">Download XLSX template</a>
  </div>

  <form method="post" enctype="multipart/form-data" class="border rounded p-3 bg-light shadow-sm mb-4">
    <div class="row g-3 align-items-end">
      <div class="col-md-6">
        <label class="form-label">Upload file (.csv or .xlsx)</label>
        <input type="file" name="file" accept=".csv,.xlsx" class="form-control" required>
      </div>
      <div class="col-md-6 text-end">
        <button class="btn btn-primary">Upload & Process</button>
      </div>
    </div>
    <div class="form-text mt-2">
      Required columns: <code>student_number</code>, <code>amount</code>. Optional: <code>asof_year</code>.
      If <code>asof_year</code> is blank, we use (active_year - 1).
    </div>
  </form>

  {% if results %}
    <div class="table-responsive">
      <table class="table table-sm table-bordered align-middle">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>Row</th>
            <th>Student Number</th>
            <th>Amount</th>
            <th>As-of Year</th>
            <th>Status</th>
            <th>Message</th>
          </tr>
        </thead>
        <tbody>
        {% for r in results %}
          <tr class="{% if r.status == 'ok' %}table-success{% elif r.status == 'error' %}table-danger{% endif %}">
            <td>{{ loop.index }}</td>
            <td>{{ r.row }}</td>
            <td>{{ r.student_number }}</td>
            <td>{{ "{:,.0f}".format(r.amount or 0) }}</td>
            <td>{{ r.asof_year or '' }}</td>
            <td>{{ r.status|upper }}</td>
            <td>{{ r.message }}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  {% endif %}
</div>
{% endblock %}
