
{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">

  <div class="d-flex align-items-center justify-content-between mb-2">
    <h4 class="text-primary mb-0">Holiday Package – Scores Hub</h4>
    <a class="btn btn-sm btn-primary" href="{{ url_for('holiday_template_csv') }}">
      Download Template (CSV)
    </a>
	<a class="btn btn-sm btn-primary" href="{{ url_for('marks_hub') }}">
    ← Back 
    </a>
  </div>

  <!-- Flash messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <div class="alert alert-info py-2">
    <strong>Active:</strong> {{ active_term }} / {{ active_year }}
  </div>

  <div class="row g-4">
    <!-- Add One Score -->
    <div class="col-lg-6">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">Add One Score</div>
        <div class="card-body">
          <form method="post" onsubmit="return hpValidateAddOne();" class="row g-3">
            <input type="hidden" name="action" value="add_one">

            <div class="col-12">
              <label class="form-label">Student Number <span class="text-danger">*</span></label>
              <input type="text" name="student_number" class="form-control" placeholder="e.g. STD-2025-001" required>
            </div>

            <div class="col-12">
              <label class="form-label">Subject (existing)</label>
              <select name="subject_id" class="form-select">
                <option value="">— Select Subject —</option>
                {% for s in subjects %}
                  <option value="{{ s.id }}">{{ s.name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-12">
              <label class="form-label">Or New Subject Name</label>
              <input type="text" name="subject_name" class="form-control" placeholder="e.g. Holiday Package">
              <div class="form-text">We’ll create this subject if it doesn’t exist.</div>
            </div>

            <div class="col-md-6">
              <label class="form-label">Assessment Type</label>
              <select name="assessment_type" class="form-select">
                <option value="Test">Test</option>
                <option value="Exercise">Exercise</option>
                <option value="Project">Project</option>
                <option value="Exam">Exam</option>
                <option value="Holiday Package" selected>Holiday Package</option>
                <option value="Other">Other</option>
              </select>
            </div>

            <div class="col-md-3">
              <label class="form-label">Score <span class="text-danger">*</span></label>
              <input type="number" step="0.01" min="0" name="score" class="form-control" required>
            </div>

            <div class="col-md-3">
              <label class="form-label">Max Score</label>
              <input type="number" step="0.01" min="1" name="max_score" value="100" class="form-control">
            </div>

            <div class="col-md-4">
              <label class="form-label">Weight (optional)</label>
              <input type="number" step="0.01" min="0" name="weight" class="form-control">
              <div class="form-text">If set, weighted average is used per subject.</div>
            </div>

            <div class="col-md-4">
              <label class="form-label">Term</label>
              <select name="term" class="form-select">
                {% for t in terms %}
                  <option value="{{ t }}" {% if t==active_term %}selected{% endif %}>{{ t }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-4">
              <label class="form-label">Year</label>
              <input type="number" name="year" class="form-control" value="{{ active_year }}">
            </div>

            <div class="col-12 text-end">
              <button class="btn btn-primary">Save Score</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Bulk Upload -->
    <div class="col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-secondary text-white">Bulk Upload (CSV / Excel)</div>
        <div class="card-body">
          <form method="post" enctype="multipart/form-data" class="row g-3">
            <input type="hidden" name="action" value="upload_csv">

            <div class="col-12">
              <label class="form-label">Select File</label>
              <input type="file" name="file" accept=".csv,.xlsx" class="form-control" required>
            </div>

            <div class="col-12">
              <div class="alert alert-light border">
                <strong>Required columns:</strong>
                <code>student_number, subject_name, assessment_type, score, term, year</code><br>
                <strong>Optional:</strong> <code>max_score</code>, <code>weight</code>
              </div>
            </div>

            <div class="col-12 text-end">
              <button class="btn btn-secondary">Upload</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Sync -->
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-success text-white">Sync Holiday Package into Reports</div>
        <div class="card-body">
          <form method="post" class="row g-3">
            <input type="hidden" name="action" value="sync">

            <div class="col-md-4">
              <label class="form-label">Class <span class="text-danger">*</span></label>
              <select name="class_name" class="form-select" required>
                <option value="">— Select Class —</option>
                {% for c in classes %}
                  <option value="{{ c }}">{{ c }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-4">
              <label class="form-label">Term</label>
              <input type="text" class="form-control" value="{{ active_term }}" disabled>
            </div>

            <div class="col-md-4">
              <label class="form-label">Year</label>
              <input type="number" class="form-control" value="{{ active_year }}" disabled>
            </div>

            <div class="col-12 text-end">
              <button class="btn btn-success">Sync Now</button>
            </div>
          </form>

          <div class="mt-2 small text-muted">
            Only subjects with at least one score for a student in the selected class/term/year
            will be pushed to <code>record_score</code>. Empty subjects will not appear on report cards.
          </div>
        </div>
      </div>
    </div>

    <!-- ================= PREVIEW (NEW) ================= -->
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
          <span>Preview Class Averages (Before Sync)</span>
        </div>
        <div class="card-body">
          <form method="get" class="row g-3 mb-3">
            <div class="col-md-4">
              <label class="form-label">Class</label>
              <select name="class_name" class="form-select" required>
                <option value="">— Select Class —</option>
                {% for c in classes %}
                  <option value="{{ c }}" {% if preview and preview.class_name==c %}selected{% endif %}>{{ c }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Term</label>
              <select name="term" class="form-select">
                {% for t in terms %}
                  {% set tt = preview.term if preview else active_term %}
                  <option value="{{ t }}" {% if t==tt %}selected{% endif %}>{{ t }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-2">
              <label class="form-label">Year</label>
              <input type="number" name="year" class="form-control" value="{{ preview.year if preview else active_year }}">
            </div>
            <div class="col-md-2 d-flex align-items-end">
              <input type="hidden" name="preview" value="1">
              <button class="btn btn-dark w-100">Load Preview</button>
            </div>
          </form>

          {% if preview %}
            {% if preview.subjects|length == 0 %}
              <div class="alert alert-warning mb-0">
                No holiday-package scores found for {{ preview.class_name }} – {{ preview.term }}/{{ preview.year }}.
              </div>
            {% else %}
              <div class="table-responsive">
                <table class="table table-bordered table-striped align-middle">
                  <thead class="table-dark">
                    <tr>
                      <th style="white-space:nowrap;">#</th>
                      <th style="white-space:nowrap;">Student</th>
                      {% for sj in preview.subjects %}
                        <th class="text-center" style="white-space:nowrap;">{{ sj.name }}</th>
                      {% endfor %}
                    </tr>
                  </thead>
                  <tbody>
                    {% for r in preview.rows %}
                      <tr>
                        <td>{{ loop.index }}</td>
                        <td style="white-space:nowrap;">
                          {{ r.student_number }} — {{ r.name }}
                        </td>
                        {% for sj in preview.subjects %}
                          {% set v = r.subjects.get(sj.id) %}
                          <td class="text-center">
                            {% if v is not none %}
                              {{ '%.1f'|format(v) }}
                            {% else %}
                              <span class="text-muted">—</span>
                            {% endif %}
                          </td>
                        {% endfor %}
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              <div class="small text-muted">
                Values shown are per-subject averages (weighted if any weight was provided in entries).
              </div>
            {% endif %}
          {% else %}
            <div class="text-muted">Choose Class/Term/Year above and click <em>Load Preview</em>.</div>
          {% endif %}
        </div>
      </div>
    </div>
    <!-- =============== /PREVIEW =============== -->

  </div> <!-- /row -->

</div>

<script>
  function hpValidateAddOne() {
    const form = event.target;
    const sid = form.querySelector('[name="subject_id"]').value.trim();
    const sname = form.querySelector('[name="subject_name"]').value.trim();
    if (!sid && !sname) {
      alert("Please select a subject OR type a new subject name.");
      return false;
    }
    return true;
  }
</script>
{% endblock %}
